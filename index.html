<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Development Cost Tracker</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2d3748;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
        }
        
        .auth-section {
            text-align: center;
            padding: 40px 20px;
        }
        
        .auth-section h2 {
            color: #4a5568;
            margin-bottom: 20px;
        }
        
        .auth-section p {
            color: #718096;
            margin-bottom: 30px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .user-details {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
        
        .section {
            margin-bottom: 40px;
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            border-left: 5px solid #667eea;
        }
        
        .section h2 {
            color: #4a5568;
            margin-top: 0;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .paid-off {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .in-progress {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .firebase-cloud {
            background: #e6fffa;
            color: #234e52;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        th {
            background: #4a5568;
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: #f7fafc;
        }
        
        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        input, select {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
            width: 100%;
            box-sizing: border-box;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
            width: 100%;
            box-sizing: border-box;
        }
        
        button:hover {
            background: #5a67d8;
        }
        
        button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }
        
        .google-signin-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: background 0.3s;
        }
        
        .google-signin-btn:hover {
            background: #3367d6;
        }
        
        .formula-explanation {
            background: #ebf8ff;
            border: 1px solid #bee3f8;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 0.9em;
            color: #2c5282;
        }
        
        .profit-positive {
            color: #22543d;
            font-weight: bold;
        }
        
        .profit-negative {
            color: #742a2a;
            font-weight: bold;
        }
        
        .estimated-timeline {
            color: #553c9a;
            font-style: italic;
        }
        
        .loading {
            text-align: center;
            color: #4a5568;
            font-style: italic;
            padding: 20px;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìö Book Development Cost Tracker <span class="status-badge firebase-cloud">‚òÅÔ∏è CLOUD SYNC</span></h1>
        
        <!-- Authentication Section -->
        <div id="authSection" class="auth-section">
            <h2>Sign in to sync your data across devices</h2>
            <p>Your book tracking data will be automatically saved and synced to all your devices.</p>
            <button class="google-signin-btn" onclick="signInWithGoogle()">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign in with Google
            </button>
        </div>

        <!-- User Info Section (shown when logged in) -->
        <div id="userSection" class="hidden">
            <div class="user-info">
                <div class="user-details">
                    <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
                    <div>
                        <div style="font-weight: 600; color: #2d3748;" id="userName"></div>
                        <div style="font-size: 14px; color: #718096;" id="userEmail"></div>
                    </div>
                </div>
                <button onclick="signOut()" style="background: #e53e3e; width: auto; padding: 8px 16px;">Sign Out</button>
            </div>
        </div>

        <!-- Main App Content (shown when logged in) -->
        <div id="appContent" class="hidden">
            <div class="section">
                <h2>üìä Books Still Paying Off <span class="status-badge in-progress">TRACKING</span></h2>
                
                <div class="input-group">
                    <div>
                        <label for="bookTitle">Book Title</label>
                        <input type="text" id="bookTitle" placeholder="Enter book title">
                    </div>
                    <div>
                        <label for="devCost">Development Cost ($)</label>
                        <input type="number" id="devCost" placeholder="0.00" step="0.01">
                    </div>
                    <div>
                        <label for="launchDate">Release Date</label>
                        <input type="date" id="launchDate">
                    </div>
                    <div>
                        <label style="opacity: 0;">Action</label>
                        <button onclick="addBook()" id="addBookBtn">Add Book</button>
                    </div>
                </div>
                
                <div id="loadingActive" class="loading">Loading your books...</div>
                <table id="activeTracking" class="hidden">
                    <thead>
                        <tr>
                            <th>Book Title</th>
                            <th>Dev Cost</th>
                            <th>Release Date</th>
                            <th>Cumulative Profit</th>
                            <th>Status</th>
                            <th>Est. Payoff</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="activeTableBody">
                    </tbody>
                </table>
                
                <div class="formula-explanation">
                    <strong>How it works:</strong> Add quarterly profit updates until cumulative profit ‚â• development cost. 
                    The system calculates estimated payoff timeline based on your average quarterly performance.
                    <br><strong>‚òÅÔ∏è Cloud Sync:</strong> Your data is automatically saved to your Google account and synced across all devices!
                </div>
            </div>
            
            <div class="section">
                <h2>‚úÖ Paid Off Books <span class="status-badge paid-off">COMPLETE</span></h2>
                
                <div id="loadingPaidOff" class="loading">Loading paid off books...</div>
                <table id="paidOffBooks" class="hidden">
                    <thead>
                        <tr>
                            <th>Book Title</th>
                            <th>Dev Cost</th>
                            <th>Months to Payoff</th>
                            <th>Final Profit at Payoff</th>
                            <th>Release Date</th>
                            <th>Payoff Date</th>
                        </tr>
                    </thead>
                    <tbody id="paidOffTableBody">
                    </tbody>
                </table>
            </div>
            
            <div class="section">
                <h2>üîÑ Quarterly Profit Updates</h2>
                
                <div class="input-group">
                    <div>
                        <label for="updateBookSelect">Select Book</label>
                        <select id="updateBookSelect">
                            <option value="">Select Book to Update</option>
                        </select>
                    </div>
                    <div>
                        <label for="quarterlyProfit">Quarterly Profit ($)</label>
                        <input type="number" id="quarterlyProfit" placeholder="0.00" step="0.01">
                    </div>
                    <div>
                        <label for="quarterYear">Quarter & Year</label>
                        <input type="text" id="quarterYear" placeholder="Q1 2025" pattern="Q[1-4] \d{4}">
                    </div>
                    <div>
                        <label style="opacity: 0;">Action</label>
                        <button onclick="updateQuarterlyProfit()" id="updateBtn">Add Quarterly Update</button>
                    </div>
                </div>
                
                <div class="formula-explanation">
                    <strong>Tip:</strong> Once a book is paid off, it automatically moves to the "Paid Off" section and you stop tracking it!
                </div>
            </div>

            <div class="section">
                <h2>üíæ Data Backup & Transfer</h2>
                
                <div class="input-group">
                    <div>
                        <button onclick="exportData()" style="background: #38a169;">üì• Export Data</button>
                    </div>
                    <div>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                        <button onclick="document.getElementById('importFile').click()" style="background: #3182ce;">üì§ Import Data</button>
                    </div>
                    <div>
                        <button onclick="clearAllData()" style="background: #e53e3e;">üóëÔ∏è Clear All Data</button>
                    </div>
                </div>
                
                <div class="formula-explanation">
                    <strong>Cloud Backup:</strong> Your data is automatically backed up to Firebase. Export for additional local backups!
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut as firebaseSignOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, collection, getDocs, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAKlawnotAQvskSGq25tSLp9hAHakrcFww",
            authDomain: "book-tracker-mc.firebaseapp.com",
            projectId: "book-tracker-mc",
            storageBucket: "book-tracker-mc.firebasestorage.app",
            messagingSenderId: "1019118853792",
            appId: "1:1019118853792:web:3919629c0e63a41b7b73c5",
            measurementId: "G-S96RJCCR6Q"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        let currentUser = null;
        let books = [];
        let paidOffBooks = [];

        // Make functions globally available
        window.signInWithGoogle = signInWithGoogle;
        window.signOut = signOut;
        window.addBook = addBook;
        window.updateQuarterlyProfit = updateQuarterlyProfit;
        window.deleteBook = deleteBook;
        window.exportData = exportData;
        window.importData = importData;
        window.clearAllData = clearAllData;

        // Authentication functions
        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('Error signing in:', error);
                alert('Failed to sign in. Please try again.');
            }
        }

        async function signOut() {
            try {
                await firebaseSignOut(auth);
            } catch (error) {
                console.error('Error signing out:', error);
            }
        }

        // Auth state observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                showUserSection();
                loadUserData();
            } else {
                currentUser = null;
                showAuthSection();
            }
        });

        function showAuthSection() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('userSection').classList.add('hidden');
            document.getElementById('appContent').classList.add('hidden');
        }

        function showUserSection() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('userSection').classList.remove('hidden');
            document.getElementById('appContent').classList.remove('hidden');
            
            // Update user info
            document.getElementById('userName').textContent = currentUser.displayName;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userAvatar').src = currentUser.photoURL;
        }

        // Data functions
        async function loadUserData() {
            if (!currentUser) return;

            try {
                // Load active books
                const activeRef = collection(db, 'users', currentUser.uid, 'activeBooks');
                const activeSnapshot = await getDocs(activeRef);
                books = activeSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Load paid off books
                const paidOffRef = collection(db, 'users', currentUser.uid, 'paidOffBooks');
                const paidOffSnapshot = await getDocs(paidOffRef);
                paidOffBooks = paidOffSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                renderTables();
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Failed to load your data. Please refresh the page.');
            }
        }

        async function saveBookToFirebase(book, collection_name = 'activeBooks') {
            if (!currentUser) return;

            try {
                const docRef = doc(db, 'users', currentUser.uid, collection_name, book.id.toString());
                await setDoc(docRef, book);
            } catch (error) {
                console.error('Error saving book:', error);
                throw error;
            }
        }

        async function deleteBookFromFirebase(bookId, collection_name = 'activeBooks') {
            if (!currentUser) return;

            try {
                const docRef = doc(db, 'users', currentUser.uid, collection_name, bookId.toString());
                await deleteDoc(docRef);
            } catch (error) {
                console.error('Error deleting book:', error);
                throw error;
            }
        }

        // App functions
        async function addBook() {
            if (!currentUser) {
                alert('Please sign in first');
                return;
            }

            const title = document.getElementById('bookTitle').value;
            const devCost = parseFloat(document.getElementById('devCost').value);
            const launchDate = document.getElementById('launchDate').value;

            if (!title || !devCost || !launchDate) {
                alert('Please fill in all fields');
                return;
            }

            const addBookBtn = document.getElementById('addBookBtn');
            addBookBtn.disabled = true;
            addBookBtn.textContent = 'Adding...';

            try {
                const newBook = {
                    id: Date.now(),
                    title,
                    devCost,
                    launchDate,
                    quarterlyUpdates: [],
                    cumulativeProfit: 0,
                    createdAt: new Date().toISOString()
                };

                await saveBookToFirebase(newBook);
                books.push(newBook);
                clearInputs();
                renderTables();
                alert('Book added successfully!');
            } catch (error) {
                alert('Failed to add book. Please try again.');
            } finally {
                addBookBtn.disabled = false;
                addBookBtn.textContent = 'Add Book';
            }
        }

        async function updateQuarterlyProfit() {
            if (!currentUser) {
                alert('Please sign in first');
                return;
            }

            const bookId = parseInt(document.getElementById('updateBookSelect').value);
            const profit = parseFloat(document.getElementById('quarterlyProfit').value);
            const quarter = document.getElementById('quarterYear').value;

            if (!bookId || isNaN(profit) || !quarter) {
                alert('Please fill in all fields');
                return;
            }

            const updateBtn = document.getElementById('updateBtn');
            updateBtn.disabled = true;
            updateBtn.textContent = 'Updating...';

            try {
                const bookIndex = books.findIndex(book => book.id === bookId);
                if (bookIndex === -1) return;

                books[bookIndex].quarterlyUpdates.push({
                    quarter,
                    profit,
                    date: new Date().toISOString()
                });

                books[bookIndex].cumulativeProfit += profit;

                // Check if book is now paid off
                if (books[bookIndex].cumulativeProfit >= books[bookIndex].devCost) {
                    const paidOffBook = {
                        ...books[bookIndex],
                        payoffDate: new Date().toISOString(),
                        monthsToPayoff: calculateMonthsToPayoff(books[bookIndex]),
                        finalProfit: books[bookIndex].cumulativeProfit
                    };
                    
                    await saveBookToFirebase(paidOffBook, 'paidOffBooks');
                    await deleteBookFromFirebase(bookId, 'activeBooks');
                    
                    paidOffBooks.push(paidOffBook);
                    books.splice(bookIndex, 1);
                    
                    alert(`üéâ "${paidOffBook.title}" is now paid off!`);
                } else {
                    await saveBookToFirebase(books[bookIndex]);
                }

                // Clear inputs and refresh
                document.getElementById('updateBookSelect').value = '';
                document.getElementById('quarterlyProfit').value = '';
                document.getElementById('quarterYear').value = '';
                
                renderTables();
            } catch (error) {
                alert('Failed to update book. Please try again.');
            } finally {
                updateBtn.disabled = false;
                updateBtn.textContent = 'Add Quarterly Update';
            }
        }

        async function deleteBook(bookId) {
            if (!currentUser) return;

            if (confirm('Are you sure you want to delete this book?')) {
                try {
                    await deleteBookFromFirebase(bookId);
                    books = books.filter(book => book.id !== bookId);
                    renderTables();
                } catch (error) {
                    alert('Failed to delete book. Please try again.');
                }
            }
        }

        function clearInputs() {
            document.getElementById('bookTitle').value = '';
            document.getElementById('devCost').value = '';
            document.getElementById('launchDate').value = '';
        }

        function calculateMonthsToPayoff(book) {
            const launchDate = new Date(book.launchDate);
            const payoffDate = new Date();
            const diffInMonths = (payoffDate.getFullYear() - launchDate.getFullYear()) * 12 + 
                               (payoffDate.getMonth() - launchDate.getMonth());
            return diffInMonths;
        }

        function estimatePayoffQuarters(book) {
            if (book.quarterlyUpdates.length === 0) return "Need data";
            
            const avgQuarterlyProfit = book.cumulativeProfit / book.quarterlyUpdates.length;
            const remaining = book.devCost - book.cumulativeProfit;
            
            if (remaining <= 0) return "Paid off!";
            if (avgQuarterlyProfit <= 0) return "No profit yet";
            
            const quartersRemaining = Math.ceil(remaining / avgQuarterlyProfit);
            return `~${quartersRemaining} quarters`;
        }

        function renderTables() {
            // Show/hide loading states
            document.getElementById('loadingActive').classList.add('hidden');
            document.getElementById('loadingPaidOff').classList.add('hidden');
            document.getElementById('activeTracking').classList.remove('hidden');
            document.getElementById('paidOffBooks').classList.remove('hidden');

            // Render active tracking table
            const activeTableBody = document.getElementById('activeTableBody');
            activeTableBody.innerHTML = '';

            books.forEach(book => {
                const row = document.createElement('tr');
                const remaining = book.devCost - book.cumulativeProfit;
                const status = remaining <= 0 ? 'Paid Off!' : `$${remaining.toFixed(2)} remaining`;
                const profitClass = book.cumulativeProfit >= 0 ? 'profit-positive' : 'profit-negative';

                row.innerHTML = `
                    <td><strong>${book.title}</strong></td>
                    <td>$${book.devCost.toFixed(2)}</td>
                    <td>${new Date(book.launchDate).toLocaleDateString()}</td>
                    <td class="${profitClass}">$${book.cumulativeProfit.toFixed(2)}</td>
                    <td>${status}</td>
                    <td class="estimated-timeline">${estimatePayoffQuarters(book)}</td>
                    <td><button onclick="deleteBook(${book.id})" style="background: #e53e3e; font-size: 12px; padding: 5px 10px; width: auto;">Delete</button></td>
                `;
                activeTableBody.appendChild(row);
            });

            // Render paid off books table
            const paidOffTableBody = document.getElementById('paidOffTableBody');
            paidOffTableBody.innerHTML = '';

            paidOffBooks.forEach(book => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${book.title}</strong></td>
                    <td>$${book.devCost.toFixed(2)}</td>
                    <td>${book.monthsToPayoff} months</td>
                    <td class="profit-positive">$${book.finalProfit.toFixed(2)}</td>
                    <td>${new Date(book.launchDate).toLocaleDateString()}</td>
                    <td>${new Date(book.payoffDate).toLocaleDateString()}</td>
                `;
                paidOffTableBody.appendChild(row);
            });

            // Update book select dropdown
            const updateBookSelect = document.getElementById('updateBookSelect');
            updateBookSelect.innerHTML = '<option value="">Select Book to Update</option>';
            books.forEach(book => {
                const option = document.createElement('option');
                option.value = book.id;
                option.textContent = book.title;
                updateBookSelect.appendChild(option);
            });
        }

        // Export/Import functions
        function exportData() {
            const dataToExport = {
                books: books,
                paidOffBooks: paidOffBooks,
                exportDate: new Date().toISOString(),
                userEmail: currentUser?.email,
                version: "2.0"
            };

            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `book-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        async function importData(event) {
            if (!currentUser) {
                alert('Please sign in first');
                return;
            }

            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.books && importedData.paidOffBooks) {
                        if (confirm('This will replace all current data. Are you sure?')) {
                            // Save to Firebase
                            for (const book of importedData.books) {
                                await saveBookToFirebase(book, 'activeBooks');
                            }
                            for (const book of importedData.paidOffBooks) {
                                await saveBookToFirebase(book, 'paidOffBooks');
                            }
                            
                            // Update local data
                            books = importedData.books;
                            paidOffBooks = importedData.paidOffBooks;
                            renderTables();
                            alert('Data imported successfully!');
                        }
                    } else {
                        alert('Invalid file format. Please select a valid backup file.');
                    }
                } catch (error) {
                    alert('Error reading file. Please make sure it\'s a valid backup file.');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }

        async function clearAllData() {
            if (!currentUser) return;

            if (confirm('This will delete ALL data permanently. Are you sure?\n\nConsider exporting a backup first!')) {
                if (confirm('Really sure? This cannot be undone!')) {
                    try {
                        // Delete from Firebase
                        for (const book of books) {
                            await deleteBookFromFirebase(book.id, 'activeBooks');
                        }
                        for (const book of paidOffBooks) {
                            await deleteBookFromFirebase(book.id, 'paidOffBooks');
                        }
                        
                        books = [];
                        paidOffBooks = [];
                        renderTables();
                        alert('All data cleared.');
                    } catch (error) {
                        alert('Failed to clear all data. Please try again.');
                    }
                }
            }
        }
    </script>
</body>
</html>