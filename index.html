<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Development Cost Tracker</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2d3748;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
        }
        
        .auth-section {
            text-align: center;
            padding: 40px 20px;
        }
        
        .auth-section h2 {
            color: #4a5568;
            margin-bottom: 20px;
        }
        
        .auth-section p {
            color: #718096;
            margin-bottom: 30px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .user-details {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
        
        .section {
            margin-bottom: 40px;
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            border-left: 5px solid #667eea;
        }
        
        .section h2 {
            color: #4a5568;
            margin-top: 0;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .paid-off {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .in-progress {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .firebase-cloud {
            background: #e6fffa;
            color: #234e52;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        th {
            background: #4a5568;
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: #f7fafc;
        }
        
        .input-group {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .quarterly-input-group {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        input, select {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
            width: 100%;
            box-sizing: border-box;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
            width: 100%;
            box-sizing: border-box;
        }
        
        button:hover {
            background: #5a67d8;
        }
        
        button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }
        
        .google-signin-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: background 0.3s;
        }
        
        .google-signin-btn:hover {
            background: #3367d6;
        }
        
        .formula-explanation {
            background: #ebf8ff;
            border: 1px solid #bee3f8;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 0.9em;
            color: #2c5282;
        }
        
        .profit-positive {
            color: #22543d;
            font-weight: bold;
        }
        
        .profit-negative {
            color: #742a2a;
            font-weight: bold;
        }
        
        .estimated-timeline {
            color: #553c9a;
            font-style: italic;
        }
        
        .loading {
            text-align: center;
            color: #4a5568;
            font-style: italic;
            padding: 20px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .edit-btn, .save-btn, .cancel-btn, .delete-btn {
            padding: 5px 10px;
            font-size: 12px;
            margin-right: 5px;
            width: 60px;
            text-align: center;
        }
        
        .edit-btn {
            background: #3182ce;
        }
        
        .save-btn {
            background: #38a169;
        }
        
        .cancel-btn {
            background: #718096;
        }
        
        .delete-btn {
            background: #e53e3e;
        }
        
        .cost-breakdown {
            font-size: 0.9em;
            color: #718096;
            margin-top: 5px;
        }
        
        .edit-row {
            background: #f0f8ff !important;
        }
        
        .edit-input {
            width: 100%;
            padding: 5px;
            border: 1px solid #667eea;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .cost-editing-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .cost-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .cost-row {
            display: flex;
            gap: 8px;
            align-items: center;
            min-height: 32px;
        }
        
        .cost-row select {
            flex: 1;
        }
        
        .cost-row input {
            width: 80px;
            flex-shrink: 0;
        }
        
        .add-cost-btn {
            background: #38a169;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            width: auto;
            white-space: nowrap;
        }
        
        .remove-cost-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            width: auto;
            flex-shrink: 0;
        }
        
        .backup-section {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìö Book Development Cost Tracker <span class="status-badge firebase-cloud">‚òÅÔ∏è CLOUD SYNC</span></h1>
        
        <!-- Authentication Section -->
        <div id="authSection" class="auth-section">
            <h2>Sign in to sync your data across devices</h2>
            <p>Your book tracking data will be automatically saved and synced to all your devices.</p>
            <button class="google-signin-btn" onclick="signInWithGoogle()">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign in with Google
            </button>
        </div>

        <!-- User Info Section (shown when logged in) -->
        <div id="userSection" class="hidden">
            <div class="user-info">
                <div class="user-details">
                    <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
                    <div>
                        <div style="font-weight: 600; color: #2d3748;" id="userName"></div>
                        <div style="font-size: 14px; color: #718096;" id="userEmail"></div>
                    </div>
                </div>
                <button onclick="signOut()" style="background: #e53e3e; width: auto; padding: 8px 16px;">Sign Out</button>
            </div>
        </div>

        <!-- Main App Content (shown when logged in) -->
        <div id="appContent" class="hidden">
            
            <!-- How it Works Section - Now First -->
            <div class="section">
                <h2>üìñ How it Works</h2>
                <div class="formula-explanation">
                    <strong>Step 1:</strong> Add books with development costs (editing, cover design, etc.)<br>
                    <strong>Step 2:</strong> Add quarterly profit updates until cumulative profit ‚â• development cost<br>
                    <strong>Step 3:</strong> Books automatically move to "Paid Off" when profitable<br><br>
                    <strong>‚òÅÔ∏è Cloud Sync:</strong> Your data is automatically saved to your Google account and synced across all devices!<br>
                    <strong>‚úèÔ∏è Editing:</strong> Click "Edit" on any book to modify its details and add/edit development costs!<br>
                    <strong>üìä Cost Tracking:</strong> Add multiple cost categories (editing, cover, formatting) for detailed breakdowns!
                </div>
            </div>
            
            <div class="section">
                <h2>üìä Books Still Paying Off <span class="status-badge in-progress">TRACKING</span></h2>
                
                <div class="input-group">
                    <div>
                        <label for="bookTitle">Book Title</label>
                        <input type="text" id="bookTitle" placeholder="Enter book title">
                    </div>
                    <div>
                        <label for="devCost">Development Cost ($)</label>
                        <input type="number" id="devCost" placeholder="0.00" step="0.01">
                    </div>
                    <div>
                        <label for="costCategory">Cost Category</label>
                        <select id="costCategory">
                            <option value="">Select category...</option>
                            <option value="Cover Design">Cover Design</option>
                            <option value="Editing">Editing</option>
                            <option value="Formatting">Formatting</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Printing">Printing</option>
                            <option value="ISBN/Copyright">ISBN/Copyright</option>
                            <option value="Illustration">Illustration</option>
                            <option value="Translation">Translation</option>
                            <option value="Software/Tools">Software/Tools</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="launchDate">Release Date (Optional)</label>
                        <input type="date" id="launchDate">
                    </div>
                    <div>
                        <label style="opacity: 0;">Action</label>
                        <button onclick="addBook()" id="addBookBtn">Add Book</button>
                    </div>
                </div>
                
                <div id="loadingActive" class="loading">Loading your books...</div>
                <table id="activeTracking" class="hidden">
                    <thead>
                        <tr>
                            <th>Book Title</th>
                            <th>Dev Cost & Category</th>
                            <th>Release Date</th>
                            <th>Cumulative Profit</th>
                            <th>Status</th>
                            <th>Est. Payoff</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="activeTableBody">
                    </tbody>
                </table>
            </div>
            
            <div class="section">
                <h2>üîÑ Quarterly Profit Updates</h2>
                
                <div class="quarterly-input-group">
                    <div>
                        <label for="updateBookSelect">Select Book</label>
                        <select id="updateBookSelect">
                            <option value="">Select Book to Update</option>
                        </select>
                    </div>
                    <div>
                        <label for="quarterlyProfit">Quarterly Profit ($)</label>
                        <input type="number" id="quarterlyProfit" placeholder="0.00" step="0.01">
                    </div>
                    <div>
                        <label for="quarterYear">Quarter & Year</label>
                        <input type="text" id="quarterYear" placeholder="Q1 2025" pattern="Q[1-4] \d{4}">
                    </div>
                    <div>
                        <label style="opacity: 0;">Action</label>
                        <button onclick="updateQuarterlyProfit()" id="updateBtn">Add Quarterly Update</button>
                    </div>
                </div>
                
                <div class="formula-explanation">
                    <strong>Tip:</strong> Once a book is paid off, it automatically moves to the "Paid Off" section. If you edit a paid off book and increase costs, it will move back here for continued tracking.<br>
                    <strong>Date Format:</strong> You can enter dates in multiple formats: "2025-03-15" (ISO), "03/15/2025" (US), "March 15, 2025" (natural), or "Q1 2025" for quarters.
                </div>
            </div>
            
            <div class="section">
                <h2>‚úÖ Paid Off Books <span class="status-badge paid-off">COMPLETE</span></h2>
                
                <div id="loadingPaidOff" class="loading">Loading paid off books...</div>
                <table id="paidOffBooks" class="hidden">
                    <thead>
                        <tr>
                            <th>Book Title</th>
                            <th>Dev Cost & Category</th>
                            <th>Months to Payoff</th>
                            <th>Release Date</th>
                            <th>Payoff Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paidOffTableBody">
                    </tbody>
                </table>
            </div>

            <div class="section">
                <h2>üíæ Data Backup & Transfer</h2>
                
                <div class="backup-section">
                    <div>
                        <button onclick="exportData()" style="background: #38a169;">üì• Export Data</button>
                    </div>
                    <div>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                        <button onclick="document.getElementById('importFile').click()" style="background: #3182ce;">üì§ Import Data</button>
                    </div>
                    <div>
                        <button onclick="clearAllData()" style="background: #e53e3e;">üóëÔ∏è Clear All Data</button>
                    </div>
                </div>
                
                <div class="formula-explanation">
                    <strong>Cloud Backup:</strong> Your data is automatically backed up to Firebase. Export for additional local backups!
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut as firebaseSignOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, collection, getDocs, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAKlawnotAQvskSGq25tSLp9hAHakrcFww",
            authDomain: "book-tracker-mc.firebaseapp.com",
            projectId: "book-tracker-mc",
            storageBucket: "book-tracker-mc.firebasestorage.app",
            messagingSenderId: "1019118853792",
            appId: "1:1019118853792:web:3919629c0e63a41b7b73c5",
            measurementId: "G-S96RJCCR6Q"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        let currentUser = null;
        let books = [];
        let paidOffBooks = [];
        let editingBookId = null;
        let editingPaidOffBookId = null;
        let editingCosts = [];
        let editingPaidOffCosts = [];

        // Make functions globally available
        window.signInWithGoogle = signInWithGoogle;
        window.signOut = signOut;
        window.addBook = addBook;
        window.updateQuarterlyProfit = updateQuarterlyProfit;
        window.deleteBook = deleteBook;
        window.deletePaidOffBook = deletePaidOffBook;
        window.editBook = editBook;
        window.saveBookEdit = saveBookEdit;
        window.cancelBookEdit = cancelBookEdit;
        window.addCostRow = addCostRow;
        window.removeCostRow = removeCostRow;
        window.updateTotalDisplay = updateTotalDisplay;
        window.editPaidOffBook = editPaidOffBook;
        window.savePaidOffBookEdit = savePaidOffBookEdit;
        window.cancelPaidOffBookEdit = cancelPaidOffBookEdit;
        window.addPaidOffCostRow = addPaidOffCostRow;
        window.removePaidOffCostRow = removePaidOffCostRow;
        window.updatePaidOffTotalDisplay = updatePaidOffTotalDisplay;
        window.updateMonthsToPayoff = updateMonthsToPayoff;
        window.exportData = exportData;
        window.importData = importData;
        window.clearAllData = clearAllData;

        // Authentication functions
        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('Error signing in:', error);
                alert('Failed to sign in. Please try again.');
            }
        }

        async function signOut() {
            try {
                await firebaseSignOut(auth);
            } catch (error) {
                console.error('Error signing out:', error);
            }
        }

        // Auth state observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                showUserSection();
                loadUserData();
            } else {
                currentUser = null;
                showAuthSection();
            }
        });

        function showAuthSection() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('userSection').classList.add('hidden');
            document.getElementById('appContent').classList.add('hidden');
        }

        function showUserSection() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('userSection').classList.remove('hidden');
            document.getElementById('appContent').classList.remove('hidden');
            
            // Update user info
            document.getElementById('userName').textContent = currentUser.displayName;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userAvatar').src = currentUser.photoURL;
        }

        // Data functions
        async function loadUserData() {
            if (!currentUser) return;

            try {
                // Load active books
                const activeRef = collection(db, 'users', currentUser.uid, 'activeBooks');
                const activeSnapshot = await getDocs(activeRef);
                books = activeSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Load paid off books
                const paidOffRef = collection(db, 'users', currentUser.uid, 'paidOffBooks');
                const paidOffSnapshot = await getDocs(paidOffRef);
                paidOffBooks = paidOffSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                renderTables();
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Failed to load your data. Please refresh the page.');
            }
        }

        async function saveBookToFirebase(book, collection_name = 'activeBooks') {
            if (!currentUser) return;

            try {
                const docRef = doc(db, 'users', currentUser.uid, collection_name, book.id.toString());
                await setDoc(docRef, book);
            } catch (error) {
                console.error('Error saving book:', error);
                throw error;
            }
        }

        async function deleteBookFromFirebase(bookId, collection_name = 'activeBooks') {
            if (!currentUser) return;

            try {
                const docRef = doc(db, 'users', currentUser.uid, collection_name, bookId.toString());
                await deleteDoc(docRef);
            } catch (error) {
                console.error('Error deleting book:', error);
                throw error;
            }
        }

        // Utility functions
        function parseQuarterToDate(quarter) {
            // Parse "Q1 2023" format to actual date
            const match = quarter.match(/^Q([1-4])\s+(\d{4})$/);
            if (!match) return new Date(); // Fallback to current date if format is wrong
            
            const quarterNum = parseInt(match[1]);
            const year = parseInt(match[2]);
            
            // Map quarters to months (using end of quarter)
            const quarterEndMonths = {
                1: 2,  // Q1 ends in March (month 2, 0-indexed)
                2: 5,  // Q2 ends in June (month 5)
                3: 8,  // Q3 ends in September (month 8)
                4: 11  // Q4 ends in December (month 11)
            };
            
            // Use last day of the quarter
            const month = quarterEndMonths[quarterNum];
            const lastDay = new Date(year, month + 1, 0).getDate(); // Get last day of month
            
            return new Date(year, month, lastDay);
        }

        function calculateMonthsToPayoff(book, payoffDate = null) {
            if (!book.launchDate) return 0;
            
            const launchDate = new Date(book.launchDate);
            const endDate = payoffDate || new Date();
            const diffInMonths = (endDate.getFullYear() - launchDate.getFullYear()) * 12 + 
                               (endDate.getMonth() - launchDate.getMonth());
            return Math.max(0, diffInMonths);
        }

        function estimatePayoffQuarters(book) {
            if (book.quarterlyUpdates.length === 0) return "Need data";
            
            const avgQuarterlyProfit = book.cumulativeProfit / book.quarterlyUpdates.length;
            const remaining = book.devCost - book.cumulativeProfit;
            
            if (remaining <= 0) return "Paid off!";
            if (avgQuarterlyProfit <= 0) return "No profit yet";
            
            const quartersRemaining = Math.ceil(remaining / avgQuarterlyProfit);
            return `~${quartersRemaining} quarters`;
        }

        function updateMonthsToPayoff(bookId) {
            const book = paidOffBooks.find(b => b.id === bookId);
            if (!book) return;

            const row = document.querySelector(`tr[data-paid-off-book-id="${bookId}"]`);
            if (!row) return;

            const launchDateInput = row.querySelector('.edit-paid-off-launch-date');
            const payoffDateInput = row.querySelector('.edit-paid-off-payoff-date');
            const monthsInput = row.querySelector('.edit-paid-off-months');

            const launchDate = launchDateInput.value;
            const payoffDate = payoffDateInput.value;

            if (launchDate && payoffDate) {
                const launch = new Date(launchDate);
                const payoff = new Date(payoffDate);
                
                const diffInMonths = (payoff.getFullYear() - launch.getFullYear()) * 12 + 
                                   (payoff.getMonth() - launch.getMonth());
                
                const months = Math.max(0, diffInMonths);
                monthsInput.value = months;
            }
        }

        // App functions
        async function addBook() {
            if (!currentUser) {
                alert('Please sign in first');
                return;
            }

            const title = document.getElementById('bookTitle').value.trim();
            const devCost = parseFloat(document.getElementById('devCost').value);
            const costCategory = document.getElementById('costCategory').value;
            const launchDate = document.getElementById('launchDate').value;

            if (!title || !devCost) {
                alert('Please fill in title and cost (release date is optional)');
                return;
            }

            const addBookBtn = document.getElementById('addBookBtn');
            addBookBtn.disabled = true;
            addBookBtn.textContent = 'Adding...';

            try {
                const newBook = {
                    id: Date.now(),
                    title,
                    devCost,
                    costBreakdown: [{
                        category: costCategory || 'Unspecified',
                        amount: devCost
                    }],
                    launchDate: launchDate || null,
                    quarterlyUpdates: [],
                    cumulativeProfit: 0,
                    createdAt: new Date().toISOString()
                };

                await saveBookToFirebase(newBook);
                books.push(newBook);
                clearInputs();
                renderTables();
                alert('Book added successfully! Use "Edit" to add more development costs.');
            } catch (error) {
                console.error('Error adding book:', error);
                alert('Failed to add book. Please try again.');
            } finally {
                addBookBtn.disabled = false;
                addBookBtn.textContent = 'Add Book';
            }
        }

        // Active book editing functions
        async function editBook(bookId) {
            editingBookId = bookId;
            const book = books.find(b => b.id === bookId);
            
            // Initialize editing costs with current breakdown
            if (book.costBreakdown) {
                editingCosts = [...book.costBreakdown];
            } else {
                // Convert old format
                editingCosts = [{
                    category: book.costCategory || 'Unspecified',
                    amount: book.devCost
                }];
            }
            
            renderTables();
        }

        function addCostRow() {
            // Capture current values before adding new row
            updateEditingCostsFromDOM();
            
            editingCosts.push({
                category: 'Other',
                amount: 0
            });
            renderTables();
        }

        function removeCostRow(index) {
            if (editingCosts.length > 1) {
                // Capture current values before removing row
                updateEditingCostsFromDOM();
                
                editingCosts.splice(index, 1);
                renderTables();
            } else {
                alert('A book must have at least one cost entry.');
            }
        }

        function updateEditingCostsFromDOM() {
            if (!editingBookId) return;
            
            const row = document.querySelector(`tr[data-book-id="${editingBookId}"]`);
            if (!row) return;
            
            const costInputs = row.querySelectorAll('.edit-cost-amount');
            const categorySelects = row.querySelectorAll('.edit-cost-category');
            
            // Update editingCosts with current DOM values
            for (let i = 0; i < Math.min(costInputs.length, editingCosts.length); i++) {
                editingCosts[i].amount = parseFloat(costInputs[i].value) || 0;
                editingCosts[i].category = categorySelects[i].value || 'Unspecified';
            }
            
            // Also capture the release date to prevent it from being wiped
            const dateInput = row.querySelector('.edit-date');
            if (dateInput) {
                editingCosts._tempReleaseDate = dateInput.value;
            }
        }

        function updateTotalDisplay() {
            if (!editingBookId) return;
            
            const row = document.querySelector(`tr[data-book-id="${editingBookId}"]`);
            if (!row) return;
            
            const costInputs = row.querySelectorAll('.edit-cost-amount');
            let total = 0;
            
            costInputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                total += value;
            });
            
            const totalDisplay = document.getElementById('editingTotal');
            if (totalDisplay) {
                totalDisplay.textContent = `Total: $${total.toFixed(2)}`;
            }
        }

        async function saveBookEdit(bookId) {
            const book = books.find(b => b.id === bookId);
            if (!book) return;

            const row = document.querySelector(`tr[data-book-id="${bookId}"]`);
            const titleInput = row.querySelector('.edit-title');
            const dateInput = row.querySelector('.edit-date');
            const costInputs = row.querySelectorAll('.edit-cost-amount');
            const categorySelects = row.querySelectorAll('.edit-cost-category');

            const newTitle = titleInput.value.trim();
            const newDate = dateInput.value;

            if (!newTitle) {
                alert('Please fill in the title');
                return;
            }

            // Validate and collect cost data
            const newCostBreakdown = [];
            let totalCost = 0;

            for (let i = 0; i < costInputs.length; i++) {
                const amount = parseFloat(costInputs[i].value);
                const category = categorySelects[i].value;

                if (isNaN(amount) || amount <= 0) {
                    alert(`Please enter a valid amount for cost #${i + 1}`);
                    return;
                }

                newCostBreakdown.push({
                    category: category || 'Unspecified',
                    amount: amount
                });
                totalCost += amount;
            }

            try {
                book.title = newTitle;
                book.launchDate = newDate || null;
                book.costBreakdown = newCostBreakdown;
                book.devCost = totalCost;

                await saveBookToFirebase(book);
                editingBookId = null;
                editingCosts = [];
                renderTables();
                alert(`Book updated successfully! Total development cost: $${totalCost.toFixed(2)}`);
            } catch (error) {
                console.error('Error updating book:', error);
                alert('Failed to update book. Please try again.');
            }
        }

        function cancelBookEdit() {
            editingBookId = null;
            editingCosts = [];
            renderTables();
        }

        // Paid off book editing functions
        async function editPaidOffBook(bookId) {
            editingPaidOffBookId = bookId;
            const book = paidOffBooks.find(b => b.id === bookId);
            
            // Initialize editing costs with current breakdown
            if (book.costBreakdown) {
                editingPaidOffCosts = [...book.costBreakdown];
            } else {
                // Convert old format
                editingPaidOffCosts = [{
                    category: book.costCategory || 'Unspecified',
                    amount: book.devCost
                }];
            }
            
            renderTables();
        }

        function addPaidOffCostRow() {
            // Capture current values before adding new row
            updatePaidOffEditingCostsFromDOM();
            
            editingPaidOffCosts.push({
                category: 'Other',
                amount: 0
            });
            renderTables();
        }

        function removePaidOffCostRow(index) {
            if (editingPaidOffCosts.length > 1) {
                // Capture current values before removing row
                updatePaidOffEditingCostsFromDOM();
                
                editingPaidOffCosts.splice(index, 1);
                renderTables();
            } else {
                alert('A book must have at least one cost entry.');
            }
        }

        function updatePaidOffEditingCostsFromDOM() {
            if (!editingPaidOffBookId) return;
            
            const row = document.querySelector(`tr[data-paid-off-book-id="${editingPaidOffBookId}"]`);
            if (!row) return;
            
            const costInputs = row.querySelectorAll('.edit-paid-off-cost-amount');
            const categorySelects = row.querySelectorAll('.edit-paid-off-cost-category');
            
            // Update editingPaidOffCosts with current DOM values
            for (let i = 0; i < Math.min(costInputs.length, editingPaidOffCosts.length); i++) {
                editingPaidOffCosts[i].amount = parseFloat(costInputs[i].value) || 0;
                editingPaidOffCosts[i].category = categorySelects[i].value || 'Unspecified';
            }
        }

        function updatePaidOffTotalDisplay() {
            if (!editingPaidOffBookId) return;
            
            const row = document.querySelector(`tr[data-paid-off-book-id="${editingPaidOffBookId}"]`);
            if (!row) return;
            
            const costInputs = row.querySelectorAll('.edit-paid-off-cost-amount');
            let total = 0;
            
            costInputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                total += value;
            });
            
            const totalDisplay = document.getElementById('editingPaidOffTotal');
            if (totalDisplay) {
                totalDisplay.textContent = `Total: $${total.toFixed(2)}`;
            }
        }

        async function savePaidOffBookEdit(bookId) {
            const book = paidOffBooks.find(b => b.id === bookId);
            if (!book) return;

            const row = document.querySelector(`tr[data-paid-off-book-id="${bookId}"]`);
            const titleInput = row.querySelector('.edit-paid-off-title');
            const monthsInput = row.querySelector('.edit-paid-off-months');
            const launchDateInput = row.querySelector('.edit-paid-off-launch-date');
            const payoffDateInput = row.querySelector('.edit-paid-off-payoff-date');
            const costInputs = row.querySelectorAll('.edit-paid-off-cost-amount');
            const categorySelects = row.querySelectorAll('.edit-paid-off-cost-category');

            const newTitle = titleInput.value.trim();
            const newMonths = parseInt(monthsInput.value);
            const newLaunchDate = launchDateInput.value;
            const newPayoffDate = payoffDateInput.value;

            if (!newTitle) {
                alert('Please fill in the title');
                return;
            }

            // Validate and collect cost data
            const newCostBreakdown = [];
            let totalCost = 0;

            for (let i = 0; i < costInputs.length; i++) {
                const amount = parseFloat(costInputs[i].value);
                const category = categorySelects[i].value;

                if (isNaN(amount) || amount <= 0) {
                    alert(`Please enter a valid amount for cost #${i + 1}`);
                    return;
                }

                newCostBreakdown.push({
                    category: category || 'Unspecified',
                    amount: amount
                });
                totalCost += amount;
            }

            try {
                book.title = newTitle;
                book.monthsToPayoff = isNaN(newMonths) ? 0 : newMonths;
                book.launchDate = newLaunchDate || null;
                book.payoffDate = newPayoffDate ? new Date(newPayoffDate).toISOString() : book.payoffDate;
                book.costBreakdown = newCostBreakdown;
                book.devCost = totalCost;

                // Check if book is no longer paid off due to increased costs
                if (book.cumulativeProfit < totalCost) {
                    // Move back to active books
                    const activeBook = {
                        id: book.id,
                        title: book.title,
                        devCost: totalCost,
                        costBreakdown: newCostBreakdown,
                        launchDate: book.launchDate,
                        quarterlyUpdates: book.quarterlyUpdates || [],
                        cumulativeProfit: book.cumulativeProfit || 0,
                        createdAt: book.createdAt || new Date().toISOString()
                    };

                    await saveBookToFirebase(activeBook, 'activeBooks');
                    await deleteBookFromFirebase(book.id, 'paidOffBooks');
                    
                    books.push(activeBook);
                    paidOffBooks = paidOffBooks.filter(b => b.id !== book.id);
                    
                    alert(`Book moved back to active tracking due to increased costs! New total: $${totalCost.toFixed(2)}`);
                } else {
                    await saveBookToFirebase(book, 'paidOffBooks');
                    alert(`Paid off book updated successfully! Total development cost: $${totalCost.toFixed(2)}`);
                }

                editingPaidOffBookId = null;
                editingPaidOffCosts = [];
                renderTables();
            } catch (error) {
                console.error('Error updating paid off book:', error);
                alert('Failed to update book. Please try again.');
            }
        }

        function cancelPaidOffBookEdit() {
            editingPaidOffBookId = null;
            editingPaidOffCosts = [];
            renderTables();
        }

        async function updateQuarterlyProfit() {
            if (!currentUser) {
                alert('Please sign in first');
                return;
            }

            const bookId = parseInt(document.getElementById('updateBookSelect').value);
            const profit = parseFloat(document.getElementById('quarterlyProfit').value);
            const quarter = document.getElementById('quarterYear').value;

            if (!bookId || isNaN(profit) || !quarter) {
                alert('Please fill in all fields');
                return;
            }

            const updateBtn = document.getElementById('updateBtn');
            updateBtn.disabled = true;
            updateBtn.textContent = 'Updating...';

            try {
                const bookIndex = books.findIndex(book => book.id === bookId);
                if (bookIndex === -1) return;

                books[bookIndex].quarterlyUpdates.push({
                    quarter,
                    profit,
                    date: new Date().toISOString()
                });

                books[bookIndex].cumulativeProfit += profit;

                // Check if book is now paid off
                if (books[bookIndex].cumulativeProfit >= books[bookIndex].devCost) {
                    const payoffDate = parseQuarterToDate(quarter);
                    
                    const paidOffBook = {
                        ...books[bookIndex],
                        payoffDate: payoffDate.toISOString(),
                        monthsToPayoff: calculateMonthsToPayoff(books[bookIndex], payoffDate),
                        finalProfit: books[bookIndex].cumulativeProfit,
                        payoffQuarter: quarter
                    };
                    
                    await saveBookToFirebase(paidOffBook, 'paidOffBooks');
                    await deleteBookFromFirebase(bookId, 'activeBooks');
                    
                    paidOffBooks.push(paidOffBook);
                    books.splice(bookIndex, 1);
                    
                    alert(`üéâ "${paidOffBook.title}" is now paid off!`);
                } else {
                    await saveBookToFirebase(books[bookIndex]);
                }

                // Clear inputs and refresh
                document.getElementById('updateBookSelect').value = '';
                document.getElementById('quarterlyProfit').value = '';
                document.getElementById('quarterYear').value = '';
                
                renderTables();
            } catch (error) {
                alert('Failed to update book. Please try again.');
            } finally {
                updateBtn.disabled = false;
                updateBtn.textContent = 'Add Quarterly Update';
            }
        }

        async function deleteBook(bookId) {
            if (!currentUser) return;

            if (confirm('Are you sure you want to delete this book?')) {
                try {
                    await deleteBookFromFirebase(bookId);
                    books = books.filter(book => book.id !== bookId);
                    renderTables();
                    alert('Book deleted successfully!');
                } catch (error) {
                    alert('Failed to delete book. Please try again.');
                }
            }
        }

        async function deletePaidOffBook(bookId) {
            if (!currentUser) return;

            if (confirm('Are you sure you want to delete this paid off book?')) {
                try {
                    await deleteBookFromFirebase(bookId, 'paidOffBooks');
                    paidOffBooks = paidOffBooks.filter(book => book.id !== bookId);
                    renderTables();
                    alert('Paid off book deleted successfully!');
                } catch (error) {
                    alert('Failed to delete paid off book. Please try again.');
                }
            }
        }

        function clearInputs() {
            document.getElementById('bookTitle').value = '';
            document.getElementById('devCost').value = '';
            document.getElementById('costCategory').value = '';
            document.getElementById('launchDate').value = '';
        }

        function renderTables() {
            // Show/hide loading states
            document.getElementById('loadingActive').classList.add('hidden');
            document.getElementById('loadingPaidOff').classList.add('hidden');
            document.getElementById('activeTracking').classList.remove('hidden');
            document.getElementById('paidOffBooks').classList.remove('hidden');

            // Render active tracking table
            const activeTableBody = document.getElementById('activeTableBody');
            activeTableBody.innerHTML = '';

            books.forEach(book => {
                const row = document.createElement('tr');
                row.setAttribute('data-book-id', book.id);
                
                const remaining = book.devCost - book.cumulativeProfit;
                const status = remaining <= 0 ? 'Paid Off!' : `$${remaining.toFixed(2)} remaining`;
                const profitClass = book.cumulativeProfit >= 0 ? 'profit-positive' : 'profit-negative';

                if (editingBookId === book.id) {
                    row.classList.add('edit-row');
                    
                    // Restore the release date if it was temporarily saved
                    const savedReleaseDate = editingCosts._tempReleaseDate || book.launchDate || '';
                    
                    // Create editable cost breakdown with real-time total update
                    let costsHtml = '';
                    editingCosts.forEach((cost, index) => {
                        costsHtml += `
                            <div class="cost-row">
                                <select class="edit-input edit-cost-category" onchange="updateTotalDisplay()">
                                    <option value="Cover Design" ${cost.category === 'Cover Design' ? 'selected' : ''}>Cover Design</option>
                                    <option value="Editing" ${cost.category === 'Editing' ? 'selected' : ''}>Editing</option>
                                    <option value="Formatting" ${cost.category === 'Formatting' ? 'selected' : ''}>Formatting</option>
                                    <option value="Marketing" ${cost.category === 'Marketing' ? 'selected' : ''}>Marketing</option>
                                    <option value="Printing" ${cost.category === 'Printing' ? 'selected' : ''}>Printing</option>
                                    <option value="ISBN/Copyright" ${cost.category === 'ISBN/Copyright' ? 'selected' : ''}>ISBN/Copyright</option>
                                    <option value="Illustration" ${cost.category === 'Illustration' ? 'selected' : ''}>Illustration</option>
                                    <option value="Translation" ${cost.category === 'Translation' ? 'selected' : ''}>Translation</option>
                                    <option value="Software/Tools" ${cost.category === 'Software/Tools' ? 'selected' : ''}>Software/Tools</option>
                                    <option value="Other" ${cost.category === 'Other' ? 'selected' : ''}>Other</option>
                                    <option value="Unspecified" ${cost.category === 'Unspecified' ? 'selected' : ''}>Unspecified</option>
                                </select>
                                <input type="number" class="edit-input edit-cost-amount" value="${cost.amount}" step="0.01" oninput="updateTotalDisplay()">
                                ${editingCosts.length > 1 ? `<button onclick="removeCostRow(${index})" class="remove-cost-btn">√ó</button>` : ''}
                            </div>
                        `;
                    });
                    
                    const totalCost = editingCosts.reduce((sum, cost) => sum + cost.amount, 0);
                    
                    row.innerHTML = `
                        <td>
                            <input type="text" class="edit-input edit-title" value="${book.title}">
                        </td>
                        <td>
                            <div class="cost-editing-container">
                                <div class="cost-header">
                                    <strong id="editingTotal">Total: $${totalCost.toFixed(2)}</strong>
                                    <button onclick="addCostRow()" class="add-cost-btn">+ Add Cost</button>
                                </div>
                                ${costsHtml}
                            </div>
                        </td>
                        <td>
                            <input type="date" class="edit-input edit-date" value="${savedReleaseDate}">
                        </td>
                        <td class="${profitClass}">$${book.cumulativeProfit.toFixed(2)}</td>
                        <td>${status}</td>
                        <td class="estimated-timeline">${estimatePayoffQuarters(book)}</td>
                        <td>
                            <button onclick="saveBookEdit(${book.id})" class="save-btn">Save</button>
                            <button onclick="cancelBookEdit()" class="cancel-btn">Cancel</button>
                        </td>
                    `;
                } else {
                    // Create cost breakdown display
                    const costBreakdownHtml = book.costBreakdown ? 
                        book.costBreakdown.map(cost => `${cost.category}: $${cost.amount.toFixed(2)}`).join('<br>') :
                        (book.costCategory || 'Unspecified');
                    
                    row.innerHTML = `
                        <td><strong>${book.title}</strong></td>
                        <td>
                            <strong>$${book.devCost.toFixed(2)}</strong>
                            <div class="cost-breakdown">${costBreakdownHtml}</div>
                        </td>
                        <td>${book.launchDate ? new Date(book.launchDate).toLocaleDateString() : 'TBD'}</td>
                        <td class="${profitClass}">$${book.cumulativeProfit.toFixed(2)}</td>
                        <td>${status}</td>
                        <td class="estimated-timeline">${estimatePayoffQuarters(book)}</td>
                        <td>
                            <button onclick="editBook(${book.id})" class="edit-btn">Edit</button>
                            <button onclick="deleteBook(${book.id})" class="delete-btn">Delete</button>
                        </td>
                    `;
                }
                activeTableBody.appendChild(row);
            });

            // Render paid off books table
            const paidOffTableBody = document.getElementById('paidOffTableBody');
            paidOffTableBody.innerHTML = '';

            paidOffBooks.forEach(book => {
                const row = document.createElement('tr');
                row.setAttribute('data-paid-off-book-id', book.id);
                
                if (editingPaidOffBookId === book.id) {
                    row.classList.add('edit-row');
                    
                    // Create editable cost breakdown for paid off books
                    let costsHtml = '';
                    editingPaidOffCosts.forEach((cost, index) => {
                        costsHtml += `
                            <div class="cost-row">
                                <select class="edit-input edit-paid-off-cost-category" onchange="updatePaidOffTotalDisplay()">
                                    <option value="Cover Design" ${cost.category === 'Cover Design' ? 'selected' : ''}>Cover Design</option>
                                    <option value="Editing" ${cost.category === 'Editing' ? 'selected' : ''}>Editing</option>
                                    <option value="Formatting" ${cost.category === 'Formatting' ? 'selected' : ''}>Formatting</option>
                                    <option value="Marketing" ${cost.category === 'Marketing' ? 'selected' : ''}>Marketing</option>
                                    <option value="Printing" ${cost.category === 'Printing' ? 'selected' : ''}>Printing</option>
                                    <option value="ISBN/Copyright" ${cost.category === 'ISBN/Copyright' ? 'selected' : ''}>ISBN/Copyright</option>
                                    <option value="Illustration" ${cost.category === 'Illustration' ? 'selected' : ''}>Illustration</option>
                                    <option value="Translation" ${cost.category === 'Translation' ? 'selected' : ''}>Translation</option>
                                    <option value="Software/Tools" ${cost.category === 'Software/Tools' ? 'selected' : ''}>Software/Tools</option>
                                    <option value="Other" ${cost.category === 'Other' ? 'selected' : ''}>Other</option>
                                    <option value="Unspecified" ${cost.category === 'Unspecified' ? 'selected' : ''}>Unspecified</option>
                                </select>
                                <input type="number" class="edit-input edit-paid-off-cost-amount" value="${cost.amount}" step="0.01" oninput="updatePaidOffTotalDisplay()">
                                ${editingPaidOffCosts.length > 1 ? `<button onclick="removePaidOffCostRow(${index})" class="remove-cost-btn">√ó</button>` : ''}
                            </div>
                        `;
                    });
                    
                    const totalCost = editingPaidOffCosts.reduce((sum, cost) => sum + cost.amount, 0);
                    
                    row.innerHTML = `
                        <td>
                            <input type="text" class="edit-input edit-paid-off-title" value="${book.title}">
                        </td>
                        <td>
                            <div class="cost-editing-container">
                                <div class="cost-header">
                                    <strong id="editingPaidOffTotal">Total: $${totalCost.toFixed(2)}</strong>
                                    <button onclick="addPaidOffCostRow()" class="add-cost-btn">+ Add Cost</button>
                                </div>
                                ${costsHtml}
                            </div>
                        </td>
                        <td>
                            <input type="number" class="edit-input edit-paid-off-months" value="${book.monthsToPayoff}" min="0" readonly style="background: #f8f9fa;">
                        </td>
                        <td>
                            <input type="date" class="edit-input edit-paid-off-launch-date" value="${book.launchDate || ''}">
                        </td>
                        <td>
                            <input type="date" class="edit-input edit-paid-off-payoff-date" value="${book.payoffDate ? book.payoffDate.split('T')[0] : ''}" onchange="updateMonthsToPayoff(${book.id})">
                        </td>
                        <td>
                            <button onclick="savePaidOffBookEdit(${book.id})" class="save-btn">Save</button>
                            <button onclick="cancelPaidOffBookEdit()" class="cancel-btn">Cancel</button>
                        </td>
                    `;
                } else {
                    // Create cost breakdown display for paid off books
                    const costBreakdownHtml = book.costBreakdown ? 
                        book.costBreakdown.map(cost => `${cost.category}: $${cost.amount.toFixed(2)}`).join('<br>') :
                        (book.costCategory || 'Unspecified');
                    
                    row.innerHTML = `
                        <td><strong>${book.title}</strong></td>
                        <td>
                            <strong>$${book.devCost.toFixed(2)}</strong>
                            <div class="cost-breakdown">${costBreakdownHtml}</div>
                        </td>
                        <td>${book.monthsToPayoff} months</td>
                        <td>${book.launchDate ? new Date(book.launchDate).toLocaleDateString() : 'TBD'}</td>
                        <td>${new Date(book.payoffDate).toLocaleDateString()}</td>
                        <td>
                            <button onclick="editPaidOffBook(${book.id})" class="edit-btn">Edit</button>
                            <button onclick="deletePaidOffBook(${book.id})" class="delete-btn">Delete</button>
                        </td>
                    `;
                }
                paidOffTableBody.appendChild(row);
            });

            // Update book select dropdown - only show books that aren't paid off
            const updateBookSelect = document.getElementById('updateBookSelect');
            updateBookSelect.innerHTML = '<option value="">Select Book to Update</option>';
            books.forEach(book => {
                // Only add books that still have remaining costs to pay off
                if (book.cumulativeProfit < book.devCost) {
                    const option = document.createElement('option');
                    option.value = book.id;
                    option.textContent = book.title;
                    updateBookSelect.appendChild(option);
                }
            });
        }

        // Export/Import functions
        function exportData() {
            const dataToExport = {
                books: books,
                paidOffBooks: paidOffBooks,
                exportDate: new Date().toISOString(),
                userEmail: currentUser?.email,
                version: "4.0"
            };

            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `book-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        async function importData(event) {
            if (!currentUser) {
                alert('Please sign in first');
                return;
            }

            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.books && importedData.paidOffBooks) {
                        if (confirm('This will replace all current data. Are you sure?')) {
                            // Save to Firebase
                            for (const book of importedData.books) {
                                await saveBookToFirebase(book, 'activeBooks');
                            }
                            for (const book of importedData.paidOffBooks) {
                                await saveBookToFirebase(book, 'paidOffBooks');
                            }
                            
                            // Update local data
                            books = importedData.books;
                            paidOffBooks = importedData.paidOffBooks;
                            renderTables();
                            alert('Data imported successfully!');
                        }
                    } else {
                        alert('Invalid file format. Please select a valid backup file.');
                    }
                } catch (error) {
                    alert('Error reading file. Please make sure it\'s a valid backup file.');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }

        async function clearAllData() {
            if (!currentUser) return;

            if (confirm('This will delete ALL data permanently. Are you sure?\n\nConsider exporting a backup first!')) {
                if (confirm('Really sure? This cannot be undone!')) {
                    try {
                        // Delete from Firebase
                        for (const book of books) {
                            await deleteBookFromFirebase(book.id, 'activeBooks');
                        }
                        for (const book of paidOffBooks) {
                            await deleteBookFromFirebase(book.id, 'paidOffBooks');
                        }
                        
                        books = [];
                        paidOffBooks = [];
                        renderTables();
                        alert('All data cleared.');
                    } catch (error) {
                        alert('Failed to clear all data. Please try again.');
                    }
                }
            }
        }
    </script>
</body>
</html>